{% extends 'base.html' %}
{% load static %}

{% block title %}Book Service - Vehicle Service{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-calendar-plus"></i> Book Service</h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="vehicle" class="form-label">Select Vehicle *</label>
                        <select class="form-select" id="vehicle" name="vehicle" required>
                            <option value="">Select a vehicle...</option>
                            {% for vehicle in vehicles %}
                                <option value="{{ vehicle.pk }}">{{ vehicle.make }} {{ vehicle.model }} ({{ vehicle.registration_number }})</option>
                            {% endfor %}
                        </select>
                        {% if not vehicles %}
                            <small class="text-danger">Please add a vehicle first. <a href="{% url 'vehicles:add' %}">Add Vehicle</a></small>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="service_center" class="form-label">Service Center *</label>
                        <select class="form-select" id="service_center" name="service_center" required>
                            <option value="">Select a service center...</option>
                            {% for center in service_centers %}
                                <option value="{{ center.pk }}">{{ center.name }} - {{ center.city }}</option>
                            {% endfor %}
                        </select>
                        {% if not service_centers %}
                            <small class="text-danger">No service centers available. Please contact administrator.</small>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Service Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.pk }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="service" class="form-label">Service *</label>
                        <select class="form-select" id="service" name="service" required>
                            <option value="">Select a service...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="booking_date" class="form-label">Preferred Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="booking_date" name="booking_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="problem_description" class="form-label">Problem Description *</label>
                        <textarea class="form-control" id="problem_description" name="problem_description" rows="4" required placeholder="Describe the issue or service needed..."></textarea>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'bookings:list' %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary" {% if not vehicles %}disabled{% endif %}>
                            <i class="bi bi-calendar-check"></i> Book Service
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('#service_center, #category').on('change', function() {
            var serviceCenterId = $('#service_center').val();
            var categoryId = $('#category').val();
            
            if (serviceCenterId) {
                var url = "{% url 'bookings:get_services' %}?service_center_id=" + serviceCenterId;
                if (categoryId) {
                    url += "&category_id=" + categoryId;
                }
                
                $.get(url, function(data) {
                    var serviceSelect = $('#service');
                    serviceSelect.empty();
                    serviceSelect.append('<option value="">Select a service...</option>');
                    
                    $.each(data.services, function(index, service) {
                        serviceSelect.append('<option value="' + service.id + '">' + 
                            service.name + ' - $' + service.price + ' (' + service.duration + ' hrs)</option>');
                    });
                });
            }
        });
    });
</script>
{% endblock %}

